# 复杂度评分标准

本文档说明复杂度评分算法和权重配置。

## 评分公式

```
Priority Score = (行数 × 0.4) + (复杂度 × 0.3) + (嵌套深度 × 0.2) + (函数数量 × 0.1)
```

---

## 各指标说明

### 1. 行数（权重：0.4）

**定义**：文件的总行数，包含注释行和代码行。

**评分规则**：
```
行数 × 0.4
```

| 行数范围 | 分类 | 评分示例 |
|---------|------|----------|
| < 130 行 | 健康 | 100 × 0.4 = 40 |
| 130 - 249 行 | 警告 | 200 × 0.4 = 80 |
| ≥ 250 行 | 关键 | 320 × 0.4 = 128 |

**目的**：反映代码的绝对规模，超过一定阈值（≥250 行）必须重构。

---

### 2. 圈复杂度（权重：0.3）

**定义**：McCabe 圈复杂度，衡量程序中独立路径的数量。

**检测工具**：
- Rust: `cargo clippy` - 检测循环复杂度
- Python: `pylint` - 计算每个函数的复杂度
- C++: `cpplint` - 评估圈复杂度
- JavaScript: `eslint` - 通过规则评估复杂度

**评分规则**：
```
平均圈复杂度 × 0.3
```

| 复杂度范围 | 分类 | 评分示例 |
|-----------|------|----------|
| < 5 | 简单 | 3 × 0.3 = 0.9 |
| 5 - 10 | 中等 | 7.5 × 0.3 = 2.25 |
| 10 - 20 | 复杂 | 15 × 0.3 = 4.5 |
| > 20 | 极高 | 25 × 0.3 = 7.5 |

**目的**：反映代码的控制流复杂度，复杂度高的代码更难维护和理解。

---

### 3. 嵌套深度（权重：0.2）

**定义**：代码的最大嵌套层级（如嵌套的 if/for/while 块）。

**评分规则**：
```
最大嵌套深度 × 0.2
```

| 嵌套深度 | 分类 | 评分示例 |
|---------|------|----------|
| 1 - 2 层 | 健康 | 2 × 0.2 = 0.4 |
| 3 - 4 层 | 警告 | 3.5 × 0.2 = 0.7 |
| ≥ 5 层 | 关键 | 6 × 0.2 = 1.2 |

**目的**：反映代码的可读性，嵌套过深的代码更难理解和维护。

**注**：当前版本的复杂度检测器尚未实现嵌套深度计算，此指标暂未使用。

---

### 4. 函数数量（权重：0.1）

**定义**：文件中定义的函数/方法总数。

**评分规则**：
```
函数数量 × 0.1
```

| 函数数量 | 分类 | 评分示例 |
|---------|------|----------|
| < 10 个 | 健康 | 8 × 0.1 = 0.8 |
| 10 - 20 个 | 警告 | 15 × 0.1 = 1.5 |
| > 20 个 | 关键 | 25 × 0.1 = 2.5 |

**目的**：反映代码的模块化程度，函数过多的文件应该拆分为多个模块。

**注**：当前版本的复杂度检测器尚未实现函数数量计算，此指标暂未使用。

---

## 降序排序

**关键**：分数越高，优先级越高。重构时按 `priority_score` **降序**处理。

### 完整评分示例

#### 示例 1：大型 Rust 文件

```
文件: src/main.rs
行数: 320 行
复杂度: 15 (圈复杂度)
嵌套深度: 6 层
函数数量: 12 个

Priority Score = 320×0.4 + 15×0.3 + 6×0.2 + 12×0.1
            = 128 + 4.5 + 1.2 + 1.2
            = 134.9

分类: 关键文件 (≥250 行)
```

#### 示例 2：中型 Python 文件

```
文件: lib/database.py
行数: 180 行
复杂度: 8 (圈复杂度)
嵌套深度: 4 层
函数数量: 15 个

Priority Score = 180×0.4 + 8×0.3 + 4×0.2 + 15×0.1
            = 72 + 2.4 + 0.8 + 1.5
            = 76.7

分类: 警告文件 (130-250 行)
```

#### 示例 3：健康 JavaScript 文件

```
文件: utils/api.js
行数: 85 行
复杂度: 3 (圈复杂度)
嵌套深度: 2 层
函数数量: 6 个

Priority Score = 85×0.4 + 3×0.3 + 2×0.2 + 6×0.1
            = 34 + 0.9 + 0.4 + 0.6
            = 35.9

分类: 健康文件 (<130 行)
```

---

## 容错机制

### Lint 工具未安装

如果检测到未安装对应的 lint 工具：
1. 显示警告信息：`⚠️  Lint 工具未安装，跳过复杂度计算`
2. 复杂度设为 0
3. 仅按行数排序（行数 × 0.4 权重）
4. 继续执行重构任务

### 未检测到语言

如果语言检测失败（返回 'unknown'）：
1. 显示警告信息：`⚠️  无法检测语言，跳过`
2. 该文件不计入统计

---

## 优先级分类

| 优先级 | 评分范围 | 处理策略 |
|--------|----------|----------|
| 高优先级 | ≥100 | 自动串行调用子 Skill |
| 中优先级 | 70 - 99.9 | 优先处理 |
| 低优先级 | <70 | 可延后处理 |

---

## 参考资料

- McCabe, T. J. (1976). "A Complexity Measure". *IEEE Transactions on Software Engineering*, SE-2(4), 308-320.
- Cargo Clippy: <https://github.com/rust-lang/rust-clippy>
- Pylint: <https://pylint.pycqa.org/>
- Cppcheck: <https://cppcheck.sourceforge.io/>
- ESLint: <https://eslint.org/>
